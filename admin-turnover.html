<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Turnover Backend – Daily Leaderboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --panel: #020617;
      --panel-soft: #030712;
      --border: #1f2937;
      --accent: #22c55e;
      --accent-soft: rgba(34,197,94,0.2);
      --accent-red: #f9735b;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #f97373;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at 0 0, #111827 0%, #020617 55%, #000 100%);
      color: var(--text);
      padding: 16px;
    }

    .page {
      max-width: 1080px;
      margin: 0 auto;
    }

    h1 {
      margin: 0 0 4px;
      font-size: 22px;
    }

    .subtitle {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 16px;
    }

    .card {
      background: var(--panel);
      border-radius: 18px;
      border: 1px solid var(--border);
      box-shadow: 0 16px 32px rgba(0,0,0,0.75);
      padding: 14px 16px 16px;
    }

    .tabs {
      display: inline-flex;
      gap: 6px;
      margin-bottom: 12px;
      padding: 3px;
      border-radius: 999px;
      background: var(--panel-soft);
      border: 1px solid var(--border);
    }

    .tab-btn {
      border: 0;
      border-radius: 999px;
      padding: 6px 16px;
      font-size: 13px;
      cursor: pointer;
      background: transparent;
      color: var(--muted);
    }

    .tab-btn.active {
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 600;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 8px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
      min-width: 140px;
    }

    label {
      color: var(--muted);
    }

    input[type="date"],
    select {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 6px 10px;
      background: var(--panel-soft);
      color: var(--text);
      font-size: 12px;
      outline: none;
    }

    textarea {
      width: 100%;
      min-height: 220px;
      resize: vertical;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--text);
      padding: 10px;
      font-size: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .hint {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
      line-height: 1.4;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-top: 8px;
    }

    button {
      font-family: inherit;
    }

    .btn {
      border-radius: 999px;
      border: 0;
      padding: 7px 16px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #022c22;
      box-shadow: 0 10px 20px rgba(34,197,94,0.6);
    }

    .btn-outline {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary {
      background: #0b1120;
      color: var(--text);
      border: 1px solid var(--border);
    }

    .status {
      font-size: 12px;
      margin-top: 4px;
      min-height: 18px;
    }

    .status.ok { color: var(--accent); }
    .status.error { color: var(--danger); }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 12px;
    }

    th, td {
      padding: 4px 6px;
      border-bottom: 1px solid #020617;
    }

    th {
      text-align: left;
      color: var(--muted);
      background: #020617;
      position: sticky;
      top: 0;
    }

    tbody tr:nth-child(even) {
      background: #020617;
    }

    .footer-note {
      font-size: 11px;
      color: var(--muted);
      margin-top: 8px;
      line-height: 1.5;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      padding: 3px 8px;
      background: rgba(148,163,184,0.1);
      font-size: 11px;
      margin-left: 4px;
    }

    .pill.green {
      background: rgba(34,197,94,0.18);
      color: #bbf7d0;
    }

    .pill.red {
      background: rgba(248,113,113,0.18);
      color: #fecaca;
    }

    input[type="file"] {
      font-size: 11px;
      color: var(--muted);
    }

    @media (max-width: 640px) {
      .row {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>Turnover Backend – Daily Leaderboard</h1>
    <div class="subtitle">
      Paste <strong>Username, Turnover</strong> for each 2-hour cumulative update.<br>
      Brazil has an extra option for <strong>00:00–03:00 (local)</strong> which will be auto-subtracted.
    </div>

    <div class="tabs">
      <button class="tab-btn active" data-country="BR" id="tabBR">Brazil</button>
      <button class="tab-btn" data-country="MX" id="tabMX">Mexico</button>
    </div>

    <div class="card">
      <div class="row">
        <div class="field">
          <label for="dateInput">
            Leaderboard Date (Mexico day)
          </label>
          <input id="dateInput" type="date">
        </div>

        <div class="field">
          <label for="slotSelect">
            Time Slot / Type
            <span class="pill green" id="countryPill">BR</span>
          </label>
          <select id="slotSelect"></select>
        </div>

        <div class="field">
          <label>
            CSV Upload (optional)
          </label>
          <input type="file" id="csvInput" accept=".csv,text/csv">
          <span class="hint">
            If you upload a CSV, its content will replace the textbox below.
          </span>
        </div>
      </div>

      <div class="field" style="margin-top:8px;">
        <label for="rawInput">
          Data input
          <span class="pill">Format: username, turnover</span>
        </label>
        <textarea id="rawInput" spellcheck="false"
          placeholder="fabiano199, 2500.50&#10;anotheruser, 1800"></textarea>
        <div class="hint">
          • You can paste from Excel – comma, semicolon or TAB are accepted.<br>
          • For <strong>Brazil BR 00:00–03:00</strong>, paste the turnover for that local time only.
        </div>
      </div>

      <div class="btn-row">
        <button class="btn btn-secondary" id="btnPreview">Preview parsed rows</button>
        <button class="btn btn-primary" id="btnSave">Save records to D1</button>
        <span class="status" id="statusText"></span>
      </div>

      <div id="previewWrapper" style="max-height:260px; overflow:auto; margin-top:8px; display:none;">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Username</th>
              <th>Turnover (local currency)</th>
            </tr>
          </thead>
          <tbody id="previewBody"></tbody>
        </table>
      </div>

      <div class="footer-note">
        • Saving uses <strong>country + date + slot</strong> as a key.<br>
        • If someone uploads wrong data: pick the same country, date &amp; slot, paste the corrected lines, then click <strong>Save</strong> – the old rows will be replaced.<br>
        • Brazil <span class="pill red">BR 00:00–03:00 (local)</span> is automatically <strong>subtracted</strong> from Brazil’s daily total before converting to USD.
      </div>

      <div class="footer-note">
        Network debug: <span id="networkDebug" style="color:#facc15;"></span>
      </div>
    </div>
  </div>

  <script>
    // --- State ---
    let currentCountry = "BR";

    const dateInput = document.getElementById("dateInput");
    const slotSelect = document.getElementById("slotSelect");
    const rawInput = document.getElementById("rawInput");
    const statusText = document.getElementById("statusText");
    const previewWrapper = document.getElementById("previewWrapper");
    const previewBody = document.getElementById("previewBody");
    const networkDebug = document.getElementById("networkDebug");
    const countryPill = document.getElementById("countryPill");
    const csvInput = document.getElementById("csvInput");

    const tabBR = document.getElementById("tabBR");
    const tabMX = document.getElementById("tabMX");

    const SLOT_OPTIONS = {
      BR: [
        { value: "00_02", label: "00:00 – 02:00 (cumulative from 00:00 Mexico)" },
        { value: "00_04", label: "00:00 – 04:00" },
        { value: "00_06", label: "00:00 – 06:00" },
        { value: "00_08", label: "00:00 – 08:00" },
        { value: "00_10", label: "00:00 – 10:00" },
        { value: "00_12", label: "00:00 – 12:00" },
        { value: "00_14", label: "00:00 – 14:00" },
        { value: "00_16", label: "00:00 – 16:00" },
        { value: "00_18", label: "00:00 – 18:00" },
        { value: "00_20", label: "00:00 – 20:00" },
        { value: "00_22", label: "00:00 – 22:00" },
        { value: "00_24", label: "00:00 – 24:00 (full day cumulative)" },
        { value: "BR_00_03", label: "BR 00:00 – 03:00 (local Brazil – deduct from day)" }
      ],
      MX: [
        { value: "00_02", label: "00:00 – 02:00 (cumulative from 00:00 Mexico)" },
        { value: "00_04", label: "00:00 – 04:00" },
        { value: "00_06", label: "00:00 – 06:00" },
        { value: "00_08", label: "00:00 – 08:00" },
        { value: "00_10", label: "00:00 – 10:00" },
        { value: "00_12", label: "00:00 – 12:00" },
        { value: "00_14", label: "00:00 – 14:00" },
        { value: "00_16", label: "00:00 – 16:00" },
        { value: "00_18", label: "00:00 – 18:00" },
        { value: "00_20", label: "00:00 – 20:00" },
        { value: "00_22", label: "00:00 – 22:00" },
        { value: "00_24", label: "00:00 – 24:00 (full day cumulative)" }
      ]
    };

    function setStatus(msg, type) {
      statusText.textContent = msg || "";
      statusText.className = "status " + (type || "");
    }

    function setNetworkDebug(msg) {
      networkDebug.textContent = msg || "";
    }

    function populateSlots() {
      const opts = SLOT_OPTIONS[currentCountry] || [];
      slotSelect.innerHTML = "";
      opts.forEach((opt) => {
        const o = document.createElement("option");
        o.value = opt.value;
        o.textContent = opt.label;
        slotSelect.appendChild(o);
      });
      countryPill.textContent = currentCountry;
    }

    function setCountry(country) {
      currentCountry = country;
      if (country === "BR") {
        tabBR.classList.add("active");
        tabMX.classList.remove("active");
      } else {
        tabMX.classList.add("active");
        tabBR.classList.remove("active");
      }
      populateSlots();
      setStatus("", "");
      setNetworkDebug("");
      previewWrapper.style.display = "none";
    }

    tabBR.addEventListener("click", () => setCountry("BR"));
    tabMX.addEventListener("click", () => setCountry("MX"));

    // Default date: today (Mexico day not needed here, just local)
    (function initDate() {
      const today = new Date();
      const y = today.getFullYear();
      const m = String(today.getMonth() + 1).padStart(2, "0");
      const d = String(today.getDate()).padStart(2, "0");
      dateInput.value = `${y}-${m}-${d}`;
    })();

    populateSlots();

    // --- CSV upload: read and dump into textarea ---
    csvInput.addEventListener("change", () => {
      const file = csvInput.files && csvInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        rawInput.value = e.target.result || "";
        setStatus("CSV loaded into textbox. Click Preview to check.", "ok");
      };
      reader.onerror = () => {
        setStatus("Failed to read CSV file.", "error");
      };
      reader.readAsText(file);
    });

    // --- Parsing ---
    function parseInput() {
      const text = rawInput.value || "";
      const lines = text.split(/\r?\n/);
      const rows = [];
      const errors = [];

      lines.forEach((line, index) => {
        const trimmed = line.trim();
        if (!trimmed) return;
        const parts = trimmed.split(/[,;\t]/).map(p => p.trim()).filter(Boolean);
        if (parts.length < 2) {
          errors.push(`Line ${index + 1}: not enough values.`);
          return;
        }
        const username = parts[0];
        const numStr = parts[1].replace(/,/g, "");
        const turnover = Number(numStr);
        if (!username) {
          errors.push(`Line ${index + 1}: missing username.`);
          return;
        }
        if (!Number.isFinite(turnover)) {
          errors.push(`Line ${index + 1}: invalid turnover "${parts[1]}".`);
          return;
        }
        rows.push({ username, turnover });
      });

      return { rows, errors };
    }

    function renderPreview() {
      const { rows, errors } = parseInput();

      if (errors.length) {
        setStatus(errors[0] + (errors.length > 1 ? ` (+${errors.length - 1} more)` : ""), "error");
      } else {
        setStatus(`Parsed ${rows.length} rows.`, rows.length ? "ok" : "");
      }

      previewBody.innerHTML = "";
      rows.forEach((r, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${r.username}</td>
          <td>${r.turnover}</td>
        `;
        previewBody.appendChild(tr);
      });

      previewWrapper.style.display = rows.length ? "block" : "none";
    }

    document.getElementById("btnPreview").addEventListener("click", () => {
      setNetworkDebug("");
      renderPreview();
    });

    // --- Save to /api-admin-save ---
    document.getElementById("btnSave").addEventListener("click", async () => {
      setNetworkDebug("");
      const date = dateInput.value;
      const slotKey = slotSelect.value;

      if (!date) {
        setStatus("Please choose a date.", "error");
        return;
      }

      const parsed = parseInput();
      if (parsed.errors.length) {
        setStatus(parsed.errors[0], "error");
        previewWrapper.style.display = "none";
        return;
      }
      if (!parsed.rows.length) {
        setStatus("No rows to save.", "error");
        return;
      }

      setStatus("Saving to D1…", "");
      const payload = {
        country: currentCountry,
        date,
        slotKey,
        rows: parsed.rows
      };

      try {
        const res = await fetch("/api-admin-save", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const text = await res.text();
        setNetworkDebug(`HTTP ${res.status}: ${text.slice(0, 120)}…`);

        let json = {};
        try { json = JSON.parse(text); } catch (e) {}

        if (!res.ok || !json.ok) {
          setStatus(json.error || `Save failed with status ${res.status}.`, "error");
        } else {
          setStatus(`Saved ${json.inserted || 0} rows for ${currentCountry} – ${date} – ${slotKey}.`, "ok");
          renderPreview();
        }
      } catch (e) {
        setStatus("Network error while saving.", "error");
        setNetworkDebug(String(e));
      }
    });
  </script>
</body>
</html>
