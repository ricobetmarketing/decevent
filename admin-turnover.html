<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Turnover Backend – Daily Leaderboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
    }
    .page {
      max-width: 960px;
      margin: 0 auto;
    }
    h1 {
      font-size: 22px;
      margin: 4px 0 12px;
    }
    .sub {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 16px;
    }
    .tabs {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid #4b5563;
      padding: 3px;
      margin-bottom: 16px;
      background: #020617;
    }
    .tab {
      border-radius: 999px;
      padding: 6px 16px;
      font-size: 13px;
      cursor: pointer;
      border: none;
      background: transparent;
      color: #9ca3af;
    }
    .tab.active {
      background: linear-gradient(135deg, #22c55e, #4ade80);
      color: #022c22;
      font-weight: 600;
    }
    .card {
      border-radius: 18px;
      border: 1px solid #374151;
      background: #020617;
      box-shadow: 0 10px 28px rgba(0, 0, 0, 0.9);
      padding: 16px;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 10px;
    }
    label {
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    input[type="date"],
    select {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      min-width: 160px;
    }
    textarea {
      width: 100%;
      min-height: 140px;
      border-radius: 10px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco,
        Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      padding: 8px;
      resize: vertical;
    }
    .hint {
      font-size: 12px;
      color: #9ca3af;
      margin: 4px 0 8px;
    }
    .btn-row {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    button {
      cursor: pointer;
    }
    button.primary {
      border-radius: 999px;
      border: none;
      padding: 8px 18px;
      font-size: 13px;
      font-weight: 600;
      background: linear-gradient(135deg, #22c55e, #4ade80);
      color: #022c22;
      box-shadow: 0 10px 20px rgba(34, 197, 94, 0.8);
    }
    button.outline {
      border-radius: 999px;
      border: 1px solid #4b5563;
      padding: 8px 16px;
      font-size: 13px;
      background: #020617;
      color: #e5e7eb;
    }
    .status {
      font-size: 13px;
      color: #e5e7eb;
    }
    .status.error {
      color: #fecaca;
    }
    .status.ok {
      color: #bbf7d0;
    }
    .small {
      font-size: 11px;
      color: #9ca3af;
    }
    .mode-toggle {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid #4b5563;
      overflow: hidden;
    }
    .mode-toggle button {
      border: none;
      padding: 4px 12px;
      font-size: 12px;
      background: transparent;
      color: #9ca3af;
    }
    .mode-toggle button.active {
      background: #111827;
      color: #e5e7eb;
    }
    .section-title {
      font-size: 13px;
      font-weight: 600;
      margin-top: 10px;
      margin-bottom: 4px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 12px;
    }
    thead {
      background: #020617;
    }
    th, td {
      border: 1px solid #374151;
      padding: 6px;
      text-align: left;
    }
    th {
      font-weight: 500;
      color: #9ca3af;
    }
    td input {
      width: 100%;
      border-radius: 6px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      padding: 3px 6px;
      font-size: 12px;
    }
    #csvInput {
      font-size: 12px;
      color: #e5e7eb;
    }
    .br-note {
      font-size: 11px;
      color: #f97316;
      margin-top: 4px;
    }
    @media (max-width: 600px) {
      .card { padding: 12px; }
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>Turnover Backend – Daily Leaderboard</h1>
    <p class="sub">
      Update the combined Brazil + Mexico leaderboard every 2 hours.<br />
      Paste or upload <strong>Username, Turnover</strong>. For Brazil you can add
      the 00:00–03:00 turnover per player in the table; it will be auto-subtracted.
    </p>

    <div class="tabs">
      <button class="tab active" data-country="BR">Brazil</button>
      <button class="tab" data-country="MX">Mexico</button>
    </div>

    <div class="card">
      <div class="row">
        <label>
          Leaderboard Date (Mexico day)
          <input type="date" id="lbDate" />
        </label>

        <label>
          Time Slot (cumulative from 00:00 Mexico)
          <select id="slotSelect">
            <option value="00-02">00:00 – 02:00</option>
            <option value="00-04">00:00 – 04:00</option>
            <option value="00-06">00:00 – 06:00</option>
            <option value="00-08">00:00 – 08:00</option>
            <option value="00-10">00:00 – 10:00</option>
            <option value="00-12">00:00 – 12:00</option>
            <option value="00-14">00:00 – 14:00</option>
            <option value="00-16">00:00 – 16:00</option>
            <option value="00-18">00:00 – 18:00</option>
            <option value="00-20">00:00 – 20:00</option>
            <option value="00-22">00:00 – 22:00</option>
            <option value="00-24">00:00 – 24:00</option>
          </select>
        </label>
      </div>

      <div class="row" style="align-items:flex-end; justify-content:space-between;">
        <div>
          <div class="section-title">Input method</div>
          <div class="mode-toggle">
            <button type="button" class="active" id="modePasteBtn">Paste</button>
            <button type="button" id="modeCsvBtn">CSV Upload</button>
          </div>
        </div>
        <div id="brExtraNote" class="br-note">
          Brazil only: use the third column in the table for <strong>00:00–03:00</strong> turnover (optional).
        </div>
      </div>

      <div id="pasteContainer">
        <p class="hint">
          Paste lines in the format:
          <br />
          <code>username,turnover</code><br />
          Example:<br />
          <code>eviegan,1222</code><br />
          <code>ninjademo,454654</code>
        </p>
        <textarea
          id="rawInput"
          placeholder="username,turnover&#10;eviegan,1222&#10;ninjademo,454654"
        ></textarea>
        <div class="btn-row">
          <button class="outline" id="parseBtn">Parse pasted data</button>
        </div>
      </div>

      <div id="csvContainer" style="display:none; margin-top:8px;">
        <p class="hint">
          Upload a CSV with columns: <code>username,turnover</code>. First row can be a header.
        </p>
        <input type="file" id="csvInput" accept=".csv" />
      </div>

      <div class="section-title">Preview & edit rows</div>
      <p class="small">
        • Column 3 is used for Brazil only (00:00–03:00 turnover, if you track it).<br />
        • You can fix usernames or numbers directly in this table before saving.<br />
        • To correct a mistake later, choose the same <strong>date + country + slot</strong> and save again; it overwrites.
      </p>

      <table>
        <thead>
          <tr>
            <th style="width:40%;">Username</th>
            <th style="width:30%;">Turnover (local)</th>
            <th style="width:30%;">BR 00:00–03:00 (optional)</th>
          </tr>
        </thead>
        <tbody id="recordsTableBody">
          <!-- rows go here -->
        </tbody>
      </table>

      <div class="btn-row" style="margin-top:10px;">
        <button class="outline" id="clearTableBtn">Clear table</button>
        <button class="primary" id="saveBtn">Save to backend</button>
        <span id="status" class="status small"></span>
      </div>

      <p class="small" style="margin-top:10px;">
        • Backend keeps full history per date / country / slot.<br />
        • The leaderboard always uses the <strong>latest cumulative slot</strong> per player.<br />
        • Brazil's 00:00–03:00 turnover (if filled) is auto-subtracted before converting to USD.
      </p>
    </div>
  </div>

  <script>
    const tabs = document.querySelectorAll(".tab");
    const lbDate = document.getElementById("lbDate");
    const slotSelect = document.getElementById("slotSelect");
    const rawInput = document.getElementById("rawInput");
    const parseBtn = document.getElementById("parseBtn");
    const csvInput = document.getElementById("csvInput");
    const recordsTableBody = document.getElementById("recordsTableBody");
    const clearTableBtn = document.getElementById("clearTableBtn");
    const saveBtn = document.getElementById("saveBtn");
    const statusEl = document.getElementById("status");

    const pasteContainer = document.getElementById("pasteContainer");
    const csvContainer = document.getElementById("csvContainer");
    const modePasteBtn = document.getElementById("modePasteBtn");
    const modeCsvBtn = document.getElementById("modeCsvBtn");
    const brExtraNote = document.getElementById("brExtraNote");

    let currentCountry = "BR";

    lbDate.value = new Date().toISOString().slice(0, 10);

    tabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        tabs.forEach((t) => t.classList.remove("active"));
        tab.classList.add("active");
        currentCountry = tab.getAttribute("data-country") || "BR";
        brExtraNote.style.display = currentCountry === "BR" ? "block" : "none";
      });
    });

    function setMode(mode) {
      if (mode === "paste") {
        modePasteBtn.classList.add("active");
        modeCsvBtn.classList.remove("active");
        pasteContainer.style.display = "block";
        csvContainer.style.display = "none";
      } else {
        modeCsvBtn.classList.add("active");
        modePasteBtn.classList.remove("active");
        pasteContainer.style.display = "none";
        csvContainer.style.display = "block";
      }
    }

    modePasteBtn.addEventListener("click", () => setMode("paste"));
    modeCsvBtn.addEventListener("click", () => setMode("csv"));

    function addRow(username, turnover, earlyAdjust) {
      const tr = document.createElement("tr");
      tr.className = "record-row";
      tr.innerHTML = `
        <td><input class="u" value="${username || ""}" /></td>
        <td><input class="t" value="${turnover || ""}" /></td>
        <td><input class="e" value="${earlyAdjust || ""}" /></td>
      `;
      recordsTableBody.appendChild(tr);
    }

    function clearTable() {
      recordsTableBody.innerHTML = "";
    }

    function parseText(text) {
      const lines = text.split(/\r?\n/).map((l) => l.trim()).filter(Boolean);
      const rows = [];
      for (const line of lines) {
        const parts = line.split(",").map((p) => p.trim());
        if (parts.length < 2) continue;
        const username = parts[0];
        const turnover = parts[1];
        rows.push({ username, turnover });
      }
      return rows;
    }

    parseBtn.addEventListener("click", () => {
      const txt = rawInput.value;
      if (!txt.trim()) {
        statusEl.textContent = "Nothing to parse.";
        statusEl.className = "status small";
        return;
      }
      const rows = parseText(txt);
      clearTable();
      rows.forEach((r) => addRow(r.username, r.turnover, ""));
      statusEl.textContent = `Parsed ${rows.length} rows. You can edit them below.`;
      statusEl.className = "status small";
    });

    csvInput.addEventListener("change", () => {
      const file = csvInput.files && csvInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const text = e.target.result || "";
        const lines = text.split(/\r?\n/).filter(Boolean);
        const rows = [];
        lines.forEach((line, idx) => {
          const parts = line.split(",").map((p) => p.trim());
          if (!parts.length) return;
          if (idx === 0 && /user/i.test(parts[0])) return; // header
          if (parts.length < 2) return;
          rows.push({ username: parts[0], turnover: parts[1] });
        });
        clearTable();
        rows.forEach((r) => addRow(r.username, r.turnover, ""));
        statusEl.textContent = `Loaded ${rows.length} rows from CSV.`;
        statusEl.className = "status small";
      };
      reader.readAsText(file);
    });

    clearTableBtn.addEventListener("click", () => {
      clearTable();
      statusEl.textContent = "Table cleared.";
      statusEl.className = "status small";
    });

    saveBtn.addEventListener("click", () => {
      const date = lbDate.value;
      const slot = slotSelect.value;

      if (!date) {
        statusEl.textContent = "Please select a date.";
        statusEl.className = "status error";
        return;
      }

      const rowEls = Array.from(document.querySelectorAll(".record-row"));
      if (!rowEls.length) {
        statusEl.textContent = "No rows to save. Paste or upload data first.";
        statusEl.className = "status error";
        return;
      }

      const records = [];
      for (const row of rowEls) {
        const u = row.querySelector(".u").value.trim();
        const t = Number(row.querySelector(".t").value || 0);
        const e = Number(row.querySelector(".e").value || 0);
        if (!u) continue;
        records.push({ username: u, turnover: t, earlyAdjust: e });
      }

      if (!records.length) {
        statusEl.textContent = "All rows are empty.";
        statusEl.className = "status error";
        return;
      }

      const payload = {
        date,
        country: currentCountry,
        slot,
        records
      };

      statusEl.textContent = "Saving...";
      statusEl.className = "status small";

      fetch("/admin/leaderboard", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.error) {
            statusEl.textContent = "Error: " + data.error;
            statusEl.className = "status error";
          } else {
            statusEl.textContent =
              `Saved ${records.length} rows for ${date} [${currentCountry}] slot ${slot}.` +
              (data.totalPlayers != null
                ? ` Players in daily board: ${data.totalPlayers}.`
                : "");
            statusEl.className = "status ok";
          }
        })
        .catch((err) => {
          console.error(err);
          statusEl.textContent = "Network error.";
          statusEl.className = "status error";
        });
    });
  </script>
</body>
</html>
