<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Daily Turnover Management System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />

  <style>
    :root { --primary-color:#198754; --sidebar-width:250px; }
    body { background:#f8f9fa; font-size:14px; }

    #sidebar{
      width:var(--sidebar-width); min-height:100vh; background:#111827;
      position:fixed; top:0; left:0; padding-top:20px; color:#fff; z-index:1000;
      box-shadow:4px 0 15px rgba(0,0,0,.35);
    }
    #sidebar h4 { font-size:1.1rem; letter-spacing:.04em; }
    #sidebar .nav-link{
      color:#9ca3af; padding:12px 20px; display:flex; align-items:center;
      transition:.2s; font-size:.96rem; border-radius:0;
    }
    #sidebar .nav-link i{ margin-right:8px; }
    #sidebar .nav-link:hover, #sidebar .nav-link.active{
      background:linear-gradient(135deg,#22c55e,#16a34a); color:#022c22;
    }

    #content{ margin-left:var(--sidebar-width); padding:20px; }
    .card-header{ background-color:var(--primary-color)!important; color:#fff!important; font-weight:600; }
    .tab-content .tab-pane{ display:none; }
    .tab-content .tab-pane.active{ display:block; }

    .text-small{ font-size:12px; }
    .status-text{ font-size:12px; margin-top:6px; min-height:18px; }
    .status-ok{ color:#16a34a; }
    .status-error{ color:#dc2626; }

    .pill-note{
      display:inline-flex; align-items:center; gap:4px;
      border-radius:999px; padding:3px 8px;
      background:rgba(148,163,184,.15); font-size:11px;
    }
    .pill-note.green{ background:rgba(34,197,94,.15); color:#15803d; }
    .pill-note.blue{ background:rgba(59,130,246,.15); color:#1d4ed8; }

    textarea{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:13px;
    }

    .badge-soft {
      background: rgba(148,163,184,.18);
      border: 1px solid rgba(148,163,184,.35);
      color: #111;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
    }
    .badge-pending { background: rgba(245,158,11,.15); border-color: rgba(245,158,11,.35); }
    .badge-approved { background: rgba(34,197,94,.15); border-color: rgba(34,197,94,.35); }
    .badge-rejected { background: rgba(239,68,68,.15); border-color: rgba(239,68,68,.35); }
    .badge-sup { background: rgba(99,102,241,.12); border-color: rgba(99,102,241,.35); }
    code { font-size: 12px; }

    /* ‚úÖ Auto-slot display box */
    .auto-slot-box{
      display:flex; align-items:center; justify-content:space-between;
      padding:6px 10px; border:1px solid #dee2e6; border-radius:6px;
      background:#f8fafc;
      font-size:13px;
    }
    .auto-slot-box b{ font-weight:700; }
  </style>
</head>
<body>

<div id="sidebar">
  <h4 class="text-center mb-4 text-warning">Turnover System</h4>
  <nav class="nav flex-column">
    <a class="nav-link active" id="global-tab" href="#global" onclick="showTab('global')">
      <i class="fas fa-globe"></i> GLOBAL Leaderboard
    </a>
    <a class="nav-link" id="brazil-tab" href="#brazil" onclick="showTab('brazil')">üáßüá∑ Brazil</a>
    <a class="nav-link" id="mexico-tab" href="#mexico" onclick="showTab('mexico')">üá≤üáΩ Mexico</a>

    <a class="nav-link" id="data-tab" href="#data" onclick="showTab('data')">
      <i class="fas fa-chart-line"></i> DATA / Analytics
    </a>

    <a class="nav-link" id="user-tab" href="#user" onclick="showTab('user')">
      <i class="fas fa-user"></i> Search User
    </a>

    <a class="nav-link" id="history-tab" href="#history" onclick="showTab('history')">
      <i class="fas fa-clock-rotate-left"></i> Upload History
    </a>

    <a class="nav-link" id="fake-tab" href="#fake" onclick="showTab('fake')">
      <i class="fas fa-user-secret"></i> Fake Username
    </a>

    <a class="nav-link" id="rollback-tab" href="#rollback" onclick="showTab('rollback')">
      <i class="fas fa-rotate-left"></i> Rollback
    </a>
  </nav>
</div>

<div id="content">
  <h1 class="h4 mb-2">Daily Turnover Management</h1>
  <p class="text-muted text-small mb-3">
    Your team updates Brazil &amp; Mexico every 2 hours. This tool saves raw data into D1, converts to USD, and builds the GLOBAL leaderboard used on the public page.
  </p>
  <hr>

  <div class="tab-content">

    <!-- ===================== DATA TAB ===================== -->
    <div class="tab-pane" id="data">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white text-dark d-flex justify-content-between align-items-center"
             style="background:#fff!important;color:#111!important;">
          <span><i class="fas fa-chart-bar me-2"></i>Turnover Analytics (USD)</span>
          <div class="d-flex gap-2">
            <button id="btnExportCsv" class="btn btn-sm btn-outline-secondary">
              <i class="fas fa-file-csv"></i> CSV
            </button>
            <button id="btnExportPdf" class="btn btn-sm btn-outline-secondary">
              <i class="fas fa-file-pdf"></i> PDF
            </button>
          </div>
        </div>

        <div class="card-body">
          <div class="row g-3 mb-3">
            <div class="col-md-3">
              <label class="form-label">Range</label>
              <select id="dataMode" class="form-select">
                <option value="daily">Today (Daily)</option>
                <option value="weekly" selected>This Week (7 days)</option>
                <option value="monthly">Last 30 Days</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Country</label>
              <select id="dataCountry" class="form-select">
                <option value="ALL" selected>Combined (BR + MX)</option>
                <option value="BR">Brazil Only</option>
                <option value="MX">Mexico Only</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Base Date (UTC-6)</label>
              <input type="date" id="dataBaseDate" class="form-control">
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <button id="btnReloadStats" class="btn btn-primary w-100">
                <i class="fas fa-sync-alt"></i> Refresh
              </button>
            </div>
          </div>

          <div id="dataStatus" class="status-text"></div>

          <div class="row g-3 mb-3">
            <div class="col-md-4">
              <div class="card border-0 shadow-sm"><div class="card-body">
                <div class="text-muted small">Total Turnover (USD)</div>
                <div id="summaryTotalUsd" class="h4 mb-0">-</div>
                <div class="text-muted small" id="summaryRangeLabel"></div>
              </div></div>
            </div>
            <div class="col-md-4">
              <div class="card border-0 shadow-sm"><div class="card-body">
                <div class="text-muted small">Top Player (by USD)</div>
                <div id="summaryTopPlayer" class="h5 mb-0">-</div>
                <div class="text-muted small" id="summaryTopPlayerUsd"></div>
              </div></div>
            </div>
            <div class="col-md-4">
              <div class="card border-0 shadow-sm"><div class="card-body">
                <div class="text-muted small">Most Consistent (Days in Top 20)</div>
                <div id="summaryConsistentPlayer" class="h5 mb-0">-</div>
                <div class="text-muted small" id="summaryConsistentDays"></div>
              </div></div>
            </div>
          </div>

          <div class="card border-0 shadow-sm mb-3">
            <div class="card-body">
              <h6 class="mb-2">Daily Turnover Trend (USD)</h6>
              <div id="chartTurnover" style="height: 300px;"></div>
            </div>
          </div>

          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <h6 class="mb-2">Top Players (Selected Range)</h6>
              <div class="table-responsive">
                <table class="table table-sm table-hover align-middle" id="tblTopPlayers">
                  <thead class="table-light">
                    <tr>
                      <th>Rank</th><th>Username</th><th>Country</th><th>Total USD (Range)</th><th>Days in Top 20</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- ===================== GLOBAL TAB ===================== -->
    <div class="tab-pane active" id="global">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-success">
          <i class="fas fa-trophy"></i> GLOBAL Leaderboard &amp; Summary (USD)
        </div>
        <div class="card-body">
          <p class="text-muted mb-3">
            Combined <strong>Brazil + Mexico</strong>, converted to USD and ranked by Score (USD).
          </p>

          <div class="row g-3 mb-3">
            <div class="col-md-3">
              <label for="globalDate" class="form-label text-small">
                Leaderboard Date <span class="pill-note blue">Mexico time (UTC-6)</span>
              </label>
              <input type="date" class="form-control form-control-sm" id="globalDate">
            </div>
            <div class="col-md-3">
              <label for="globalPlayer" class="form-label text-small">Filter by Username</label>
              <input type="text" class="form-control form-control-sm" id="globalPlayer" placeholder="e.g. fabiano199">
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <button class="btn btn-secondary btn-sm w-100" id="globalSearchBtn">
                <i class="fas fa-search"></i> Load Leaderboard
              </button>
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <div id="globalStatus" class="status-text"></div>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-striped table-hover table-sm align-middle">
              <thead class="table-dark">
                <tr>
                  <th style="width:60px;">Rank</th>
                  <th>Username</th>
                  <th style="width:90px;">Country</th>
                  <th style="width:150px;">Score (USD)</th>
                </tr>
              </thead>
              <tbody id="globalTableBody"></tbody>
            </table>
          </div>

          <p class="text-small text-muted mt-2 mb-0">
            To correct data: re-upload <strong>Brazil</strong> or <strong>Mexico</strong> with the same <strong>date</strong>.
          </p>
        </div>
      </div>
    </div>

    <!-- ===================== BRAZIL TAB (AUTO SLOT) ===================== -->
    <div class="tab-pane" id="brazil">
      <div class="card shadow-sm mb-4">
        <div class="card-header">üáßüá∑ Brazil Turnover Data Entry (BRL)</div>
        <div class="card-body">
          <p class="text-small text-danger mb-2">
            ‚ö†Ô∏è Select the <strong>Mexico day (UTC-6)</strong>. Slot is <b>AUTO</b> (no dropdown).
          </p>

          <div class="row g-3 mb-3">
            <div class="col-md-4">
              <label for="brDate" class="form-label text-small">
                Leaderboard Date <span class="pill-note blue">Mexico (UTC-6)</span>
              </label>
              <input type="date" class="form-control form-control-sm" id="brDate">
            </div>

            <div class="col-md-4">
              <label class="form-label text-small">
                Time Slot / Type <span class="pill-note green">Cumulative</span>
              </label>
              <div class="auto-slot-box">
                <div>
                  <b id="brAutoSlotKey">AUTO</b>
                </div>
                <span class="text-muted text-small" id="brAutoSlotLabel">00:00 ‚Äì --:-- (UTC-6)</span>
              </div>
              <div class="text-muted text-small mt-1">
                Slot is computed server-side (¬±30 min safe window).
              </div>
            </div>
          </div>

          <div class="d-flex mb-2">
            <button class="btn btn-sm btn-outline-primary me-2" onclick="toggleMode('brazil','manual')">Manual Entry</button>
            <button class="btn btn-sm btn-outline-primary" onclick="toggleMode('brazil','csv')">CSV Upload</button>
          </div>

          <div id="brazil-manual" class="data-mode">
            <label for="brDataArea" class="form-label text-small">Paste data <span class="pill-note">username, cumulative BRL</span></label>
            <textarea class="form-control" id="brDataArea" rows="7" placeholder="fabiano199, 2500.50"></textarea>
          </div>

          <div id="brazil-csv" class="data-mode" style="display:none;">
            <label for="brCsvFile" class="form-label text-small">Upload CSV (.csv)</label>
            <input type="file" class="form-control form-control-sm" id="brCsvFile" accept=".csv">
            <a href="#" id="brTemplateLink" class="d-inline-block mt-1 text-small"><i class="fas fa-download"></i> Download CSV template</a>
          </div>

          <div class="mt-3">
            <button type="button" class="btn btn-primary btn-sm" onclick="saveCountry('BR')">
              <i class="fas fa-upload"></i> Save Brazil data
            </button>
            <div id="brStatus" class="status-text"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===================== MEXICO TAB (AUTO SLOT) ===================== -->
    <div class="tab-pane" id="mexico">
      <div class="card shadow-sm mb-4">
        <div class="card-header">üá≤üáΩ Mexico Turnover Data Entry (MXN)</div>
        <div class="card-body">
          <p class="text-small text-info mb-2">
            ‚ÑπÔ∏è Mexico day cycle: <strong>00:00 ‚Äì 23:59 (UTC-6)</strong>. Slot is <b>AUTO</b>.
          </p>

          <div class="row g-3 mb-3">
            <div class="col-md-4">
              <label for="mxDate" class="form-label text-small">
                Leaderboard Date <span class="pill-note blue">Mexico (UTC-6)</span>
              </label>
              <input type="date" class="form-control form-control-sm" id="mxDate">
            </div>

            <div class="col-md-4">
              <label class="form-label text-small">
                Time Slot / Type <span class="pill-note green">Cumulative</span>
              </label>
              <div class="auto-slot-box">
                <div>
                  <b id="mxAutoSlotKey">AUTO</b>
                </div>
                <span class="text-muted text-small" id="mxAutoSlotLabel">00:00 ‚Äì --:-- (UTC-6)</span>
              </div>
              <div class="text-muted text-small mt-1">
                Slot is computed server-side (¬±30 min safe window).
              </div>
            </div>
          </div>

          <div class="d-flex mb-2">
            <button class="btn btn-sm btn-outline-primary me-2" onclick="toggleMode('mexico','manual')">Manual Entry</button>
            <button class="btn btn-sm btn-outline-primary" onclick="toggleMode('mexico','csv')">CSV Upload</button>
          </div>

          <div id="mexico-manual" class="data-mode">
            <label for="mxDataArea" class="form-label text-small">Paste data <span class="pill-note">username, cumulative MXN</span></label>
            <textarea class="form-control" id="mxDataArea" rows="7" placeholder="mxplayer01, 20000.00"></textarea>
          </div>

          <div id="mexico-csv" class="data-mode" style="display:none;">
            <label for="mxCsvFile" class="form-label text-small">Upload CSV (.csv)</label>
            <input type="file" class="form-control form-control-sm" id="mxCsvFile" accept=".csv">
            <a href="#" id="mxTemplateLink" class="d-inline-block mt-1 text-small"><i class="fas fa-download"></i> Download CSV template</a>
          </div>

          <div class="mt-3">
            <button type="button" class="btn btn-primary btn-sm" onclick="saveCountry('MX')">
              <i class="fas fa-upload"></i> Save Mexico data
            </button>
            <div id="mxStatus" class="status-text"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===================== FAKE TAB ===================== -->
    <div class="tab-pane" id="fake">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white text-dark" style="background:#fff!important;color:#111!important;">
          <i class="fas fa-user-secret me-2"></i> Fake Username (Daily Boost)
        </div>

        <div class="card-body">
          <div class="row g-3 align-items-end mb-2">
            <div class="col-md-3">
              <label class="form-label text-small">Date (UTC-6)</label>
              <input type="date" id="fakeDate" class="form-control form-control-sm">
            </div>

            <div class="col-md-2">
              <label class="form-label text-small">Country</label>
              <select id="fakeCountry" class="form-select form-select-sm">
                <option value="ALL" selected>ALL (Global)</option>
                <option value="BR">BR</option>
                <option value="MX">MX</option>
              </select>
            </div>

            <div class="col-md-3">
              <label class="form-label text-small">Username</label>
              <input id="fakeUsername" class="form-control form-control-sm" placeholder="e.g. luckyking88">
            </div>

            <div class="col-md-2">
              <label class="form-label text-small">Boost %</label>
              <input id="fakeBoost" type="number" step="0.01" class="form-control form-control-sm" placeholder="e.g. 12.5">
            </div>

            <div class="col-md-2">
              <button class="btn btn-success btn-sm w-100" id="btnFakeSave">
                <i class="fas fa-save"></i> Save
              </button>
            </div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-md-10">
              <input id="fakeNote" class="form-control form-control-sm" placeholder="Note (optional)">
            </div>
            <div class="col-md-2 d-flex align-items-center">
              <div id="fakeStatus" class="status-text"></div>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle" id="tblFake">
              <thead class="table-light">
                <tr>
                  <th style="width:70px;">Active</th>
                  <th>Username</th>
                  <th style="width:90px;">Country</th>
                  <th style="width:120px;">Boost %</th>
                  <th>Note</th>
                  <th style="width:170px;">Created</th>
                  <th style="width:140px;">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="text-muted text-small mt-2">
            Boost is based on <b>current Top real player</b> (Option 1). Fake turnover = TopRealUSD √ó (Boost% / 100).
          </div>
        </div>
      </div>
    </div>

    <!-- ===================== USER SEARCH ===================== -->
    <div class="tab-pane" id="user">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white text-dark" style="background:#fff!important;color:#111!important;">
          <i class="fas fa-user me-2"></i> Search User History
        </div>
        <div class="card-body">
          <div class="row g-3 mb-2">
            <div class="col-md-4">
              <label class="form-label text-small">Username</label>
              <input id="uSearchName" type="text" class="form-control form-control-sm" placeholder="e.g. fabiano199">
            </div>
            <div class="col-md-3">
              <label class="form-label text-small">Country (optional)</label>
              <select id="uSearchCountry" class="form-select form-select-sm">
                <option value="" selected>All</option>
                <option value="BR">BR</option>
                <option value="MX">MX</option>
              </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <button class="btn btn-secondary btn-sm w-100" id="btnUserSearch">
                <i class="fas fa-search"></i> Search
              </button>
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <div id="userStatus" class="status-text"></div>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>Date</th>
                  <th>Slot</th>
                  <th>Country</th>
                  <th>Turnover (Local)</th>
                  <th>Batch</th>
                  <th>Uploaded</th>
                </tr>
              </thead>
              <tbody id="userTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ===================== UPLOAD HISTORY (VERIFY / REJECT) ===================== -->
    <div class="tab-pane" id="history">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white text-dark" style="background:#fff!important;color:#111!important;">
          <i class="fas fa-clock-rotate-left me-2"></i> Upload History Log (Verify / Reject)
        </div>
        <div class="card-body">
          <div class="row g-3 mb-2">
            <div class="col-md-3">
              <label class="form-label text-small">Date (optional)</label>
              <input id="hDate" type="date" class="form-control form-control-sm">
            </div>
            <div class="col-md-3">
              <label class="form-label text-small">Country (optional)</label>
              <select id="hCountry" class="form-select form-select-sm">
                <option value="" selected>All</option>
                <option value="BR">BR</option>
                <option value="MX">MX</option>
              </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <button class="btn btn-secondary btn-sm w-100" id="btnHistoryLoad">
                <i class="fas fa-list"></i> Load
              </button>
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <div id="historyStatus" class="status-text"></div>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>Created</th>
                  <th>Date</th>
                  <th>Country</th>
                  <th>Slot</th>
                  <th>Status</th>
                  <th>Rows</th>
                  <th>Total Local</th>
                  <th>Total USD</th>
                  <th>Uploader</th>
                  <th>Verified By</th>
                  <th>Batch</th>
                  <th style="min-width:260px;">Action</th>
                </tr>
              </thead>
              <tbody id="historyTableBody"></tbody>
            </table>
          </div>

          <p class="text-muted text-small mb-0">
            Tip: click <b>View</b> to compare uploaded rows vs current published rows.
          </p>
        </div>
      </div>
    </div>

    <!-- ===================== ROLLBACK ===================== -->
    <div class="tab-pane" id="rollback">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white text-dark" style="background:#fff!important;color:#111!important;">
          <i class="fas fa-rotate-left me-2"></i> Rollback (Restore Previous Upload)
        </div>
        <div class="card-body">
          <div class="row g-3 mb-2">
            <div class="col-md-3">
              <label class="form-label text-small">Date (UTC-6)</label>
              <input id="rbDate" type="date" class="form-control form-control-sm">
            </div>
            <div class="col-md-2">
              <label class="form-label text-small">Country</label>
              <select id="rbCountry" class="form-select form-select-sm">
                <option value="BR">BR</option>
                <option value="MX">MX</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label text-small">Slot Key</label>
              <input id="rbSlot" type="text" class="form-control form-control-sm" placeholder="e.g. 00_12 or BR_00_03">
              <div class="text-muted text-small mt-1">
                Note: save is AUTO slot now, but rollback still requires exact slotKey.
              </div>
            </div>
            <div class="col-md-4">
              <label class="form-label text-small">Rollback to Batch ID</label>
              <input id="rbBatch" type="text" class="form-control form-control-sm" placeholder="paste batch_id from history">
            </div>
          </div>

          <div class="row g-3 mt-1">
            <div class="col-md-4">
              <label class="form-label text-small">Admin Key</label>
              <input id="rbKey" type="password" class="form-control form-control-sm" placeholder="(same key used in your rollback API)">
            </div>
            <div class="col-md-4 d-flex align-items-end">
              <button class="btn btn-danger btn-sm w-100" id="btnRollback">
                <i class="fas fa-triangle-exclamation"></i> Rollback Now
              </button>
            </div>
            <div class="col-md-4 d-flex align-items-end">
              <div id="rbStatus" class="status-text"></div>
            </div>
          </div>

          <div class="text-small text-muted mt-2">
            This will restore the selected <b>batch</b> as the current data for the same <b>date + country + slot</b>.
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- ===================== MODAL: Batch Details (Cross-check) ===================== -->
<div class="modal fade" id="batchDetailsModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Batch Cross-Check (New vs Current Published)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div id="batchDetailsStatus" class="status-text mb-2"></div>

        <div class="row g-3">
          <div class="col-md-6">
            <div class="card shadow-sm">
              <div class="card-header bg-dark">New Upload (selected batch)</div>
              <div class="card-body" id="newBatchBox">-</div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card shadow-sm">
              <div class="card-header bg-secondary">Current Published (APPROVED)</div>
              <div class="card-body" id="currentBatchBox">-</div>
            </div>
          </div>
        </div>

        <hr />

        <div class="row g-3">
          <div class="col-md-6">
            <h6 class="mb-2">Top 50 rows ‚Äî New Batch</h6>
            <div class="table-responsive">
              <table class="table table-sm table-striped">
                <thead class="table-light"><tr><th>#</th><th>Username</th><th>Raw Turnover</th></tr></thead>
                <tbody id="tblNewRows"></tbody>
              </table>
            </div>
          </div>

          <div class="col-md-6">
            <h6 class="mb-2">Top 50 rows ‚Äî Current Published</h6>
            <div class="table-responsive">
              <table class="table table-sm table-striped">
                <thead class="table-light"><tr><th>#</th><th>Username</th><th>Raw Turnover</th></tr></thead>
                <tbody id="tblCurrentRows"></tbody>
              </table>
            </div>
          </div>
        </div>

      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- ===================== MODAL: Reject ===================== -->
<div class="modal fade" id="rejectModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Reject Batch</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="mb-2 text-muted text-small">
          Batch: <code id="rejectBatchId">-</code>
        </div>

        <label class="form-label">Reject reason</label>
        <textarea id="rejectReason" class="form-control" rows="4"
          placeholder="Example: wrong date / missing users / duplicated / not latest cumulative slot..."></textarea>

        <div id="rejectStatus" class="status-text mt-2"></div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-danger" onclick="submitReject()">Reject</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<script>
  // ------- TAB SWITCHING -------
  function showTab(tabId) {
    document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('#sidebar .nav-link').forEach(l => l.classList.remove('active'));

    const pane = document.getElementById(tabId);
    const link = document.getElementById(tabId + '-tab');

    if (pane) pane.classList.add('active');
    if (link) link.classList.add('active');

    if (tabId === 'data') loadStats();
    if (tabId === 'fake') loadFakeList();
    if (tabId === 'history') loadUploadHistory();
  }

  function toggleMode(country, mode) {
    const manualDiv = document.getElementById(country + '-manual');
    const csvDiv = document.getElementById(country + '-csv');
    if (!manualDiv || !csvDiv) return;
    if (mode === 'manual') { manualDiv.style.display='block'; csvDiv.style.display='none'; }
    else { manualDiv.style.display='none'; csvDiv.style.display='block'; }
  }

  function setAnyStatus(id, msg, type) {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = msg || "";
    el.classList.remove("status-ok","status-error");
    if (type === "ok") el.classList.add("status-ok");
    if (type === "error") el.classList.add("status-error");
  }

  function setStatus(prefix, message, type) {
    const el = document.getElementById(prefix.toLowerCase() + 'Status');
    if (!el) return;
    el.textContent = message || '';
    el.classList.remove('status-ok','status-error');
    if (type === 'ok') el.classList.add('status-ok');
    if (type === 'error') el.classList.add('status-error');
  }

  function setGlobalStatus(msg, type) {
    const el = document.getElementById('globalStatus');
    el.textContent = msg || '';
    el.classList.remove('status-ok','status-error');
    if (type === 'ok') el.classList.add('status-ok');
    if (type === 'error') el.classList.add('status-error');
  }

  function setDataStatus(msg, type) {
    const el = document.getElementById('dataStatus');
    el.textContent = msg || '';
    el.classList.remove('status-ok','status-error');
    if (type === 'ok') el.classList.add('status-ok');
    if (type === 'error') el.classList.add('status-error');
  }

  function parseLines(text) {
    const lines = (text||'').split(/\r?\n/);
    const rows = [];
    const errors = [];
    lines.forEach((line, idx) => {
      const t = line.trim(); if (!t) return;
      const parts = t.split(/[,;\t]/).map(p=>p.trim()).filter(Boolean);
      if (parts.length < 2) return errors.push(`Line ${idx+1}: not enough values`);
      const username = parts[0];
      const turnover = Number(String(parts[1]).replace(/,/g,''));
      if (!username) return errors.push(`Line ${idx+1}: missing username`);
      if (!Number.isFinite(turnover)) return errors.push(`Line ${idx+1}: invalid turnover`);
      rows.push({ username, turnover });
    });
    return { rows, errors };
  }

  function setupCsvUpload(fileInputId, textareaId) {
    const fileInput = document.getElementById(fileInputId);
    const textarea = document.getElementById(textareaId);
    if (!fileInput || !textarea) return;
    fileInput.addEventListener('change', () => {
      const file = fileInput.files && fileInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => { textarea.value = e.target.result || ''; };
      reader.readAsText(file);
    });
  }
  setupCsvUpload('brCsvFile','brDataArea');
  setupCsvUpload('mxCsvFile','mxDataArea');

  function setupTemplateLink(linkId, examplePrefix) {
    const link = document.getElementById(linkId);
    if (!link) return;
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const csv = "username,turnover\n" + examplePrefix + "player01,1500.00\n" + examplePrefix + "player02,900.00\n";
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = examplePrefix + "template.csv";
      a.click();
      URL.revokeObjectURL(url);
    });
  }
  setupTemplateLink('brTemplateLink','br');
  setupTemplateLink('mxTemplateLink','mx');

  // ‚úÖ Display-only auto slot (backend is source of truth)
  function computeAutoSlotDisplay(toleranceMin = 30) {
    const mex = new Date(Date.now() + (-6 * 60 * 60 * 1000));
    const h = mex.getHours();
    const m = mex.getMinutes();
    const totalMin = h * 60 + m;

    const step = 120; // 2h
    const prev = Math.floor(totalMin / step) * step;
    const next = prev + step;

    const diffNext = next - totalMin;

    let chosen = prev;
    if (diffNext <= toleranceMin) chosen = next;

    let endHour = Math.round(chosen / 60);
    if (endHour < 2) endHour = 2;
    if (endHour > 24) endHour = 24;

    const slotKey = `00_${String(endHour).padStart(2,"0")}`;
    const label = `00:00 ‚Äì ${String(endHour).padStart(2,"0")}:00 (UTC-6)`;
    return { slotKey, label };
  }

  function refreshAutoSlotUI() {
    const { slotKey, label } = computeAutoSlotDisplay(30);

    const brKey = document.getElementById("brAutoSlotKey");
    const brLbl = document.getElementById("brAutoSlotLabel");
    if (brKey) brKey.textContent = slotKey;
    if (brLbl) brLbl.textContent = label;

    const mxKey = document.getElementById("mxAutoSlotKey");
    const mxLbl = document.getElementById("mxAutoSlotLabel");
    if (mxKey) mxKey.textContent = slotKey;
    if (mxLbl) mxLbl.textContent = label;
  }

  async function saveCountry(countryCode) {
    const upper = countryCode.toUpperCase();
    const dateEl = document.getElementById(upper === 'BR' ? 'brDate' : 'mxDate');
    const textareaEl = document.getElementById(upper === 'BR' ? 'brDataArea' : 'mxDataArea');

    const date = dateEl.value;
    if (!date) return setStatus(upper, 'Please choose a leaderboard date.', 'error');

    const parsed = parseLines(textareaEl.value);
    if (parsed.errors.length) return setStatus(upper, parsed.errors[0], 'error');
    if (!parsed.rows.length) return setStatus(upper, 'No rows to save.', 'error');

    setStatus(upper, `Saving ${parsed.rows.length} rows‚Ä¶ (AUTO SLOT)`, '');

    try {
      // ‚úÖ slotKey removed
      const res = await fetch('/api-admin-save', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ country: upper, date, rows: parsed.rows })
      });
      const json = await res.json().catch(()=>({}));
      if (!res.ok || !json.ok) return setStatus(upper, json.error || `Save failed (${res.status})`, 'error');

      setStatus(upper, `Saved ${json.inserted || 0} rows for ${upper} [${date}, ${json.slotKey || "AUTO"}].`, 'ok');
      await loadGlobalLeaderboard();
      await loadStats();
      await loadUploadHistory();
    } catch (e) {
      setStatus(upper, 'Network error while saving.', 'error');
    }
  }

  async function loadGlobalLeaderboard() {
    const date = document.getElementById('globalDate').value;
    const filter = (document.getElementById('globalPlayer').value || '').trim().toLowerCase();
    const tbody = document.getElementById('globalTableBody');
    if (!date) return setGlobalStatus('Please choose a date first.', 'error');

    setGlobalStatus('Loading leaderboard‚Ä¶', '');
    tbody.innerHTML = '';

    try {
      const res = await fetch('/api-leaderboard?date=' + encodeURIComponent(date));
      const json = await res.json().catch(()=>({}));
      if (!res.ok || !json.ok) return setGlobalStatus(json.error || `Error ${res.status}`, 'error');

      const rows = (json.rows || []).filter(r => !filter || String(r.username||'').toLowerCase().includes(filter));

      if (!rows.length) {
        setGlobalStatus('No entries for ' + (json.date || date) + ' yet.', '');
        return;
      }

      rows.forEach(p => {
        const flag = p.country === 'BR' ? 'üáßüá∑' : (p.country === 'MX' ? 'üá≤üáΩ' : 'üåê');
        const tr = document.createElement('tr');
        tr.innerHTML =
          `<td>${p.rank ?? '-'}</td>
           <td>${p.username || ''}</td>
           <td>${flag} ${p.country || ''}</td>
           <td>$${Number(p.usd_turnover || 0).toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });

      setGlobalStatus(`Showing ${rows.length} players for ${json.date || date}.`, 'ok');
    } catch (e) {
      setGlobalStatus('Network error loading leaderboard.', 'error');
    }
  }
  document.getElementById('globalSearchBtn')?.addEventListener('click', loadGlobalLeaderboard);

  // ===== DATA / ANALYTICS =====
  let statsCache = null;
  let chart = null;

  function renderChart(series) {
    const categories = (series || []).map(x => x.date);
    const data = (series || []).map(x => Number(x.totalUsd || 0));

    const options = {
      chart: { type: 'line', height: 300, toolbar: { show: false } },
      series: [{ name: 'Total USD', data }],
      xaxis: { categories },
      yaxis: { labels: { formatter: (v) => Number(v).toFixed(2) } },
      stroke: { width: 3 },
      dataLabels: { enabled: false }
    };

    if (!chart) {
      chart = new ApexCharts(document.querySelector("#chartTurnover"), options);
      chart.render();
    } else {
      chart.updateOptions(options, true, true);
    }
  }

  function renderTable(topPlayersOverall) {
    const tbody = document.querySelector('#tblTopPlayers tbody');
    tbody.innerHTML = '';
    (topPlayersOverall || []).slice(0, 20).forEach(p => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.rank}</td>
        <td>${p.username}</td>
        <td>${p.country}</td>
        <td>$${Number(p.totalUsd || 0).toFixed(2)}</td>
        <td>${p.daysInTop20}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderSummary(payload) {
    const totalRangeUsd = (payload.perDay || []).reduce((sum, d) => sum + (Number(d.totalUsd)||0), 0);
    document.getElementById('summaryTotalUsd').textContent = '$' + totalRangeUsd.toFixed(2);
    document.getElementById('summaryRangeLabel').textContent =
      `${payload.fromDate} ‚Üí ${payload.toDate} (${payload.mode}, ${payload.country})`;

    const top = (payload.topPlayersOverall || [])[0];
    document.getElementById('summaryTopPlayer').textContent = top ? `${top.username} (${top.country})` : '-';
    document.getElementById('summaryTopPlayerUsd').textContent = top ? `$${Number(top.totalUsd||0).toFixed(2)} in range` : '';

    const consistent = (payload.topPlayersOverall || []).slice().sort((a,b)=>b.daysInTop20-a.daysInTop20)[0];
    document.getElementById('summaryConsistentPlayer').textContent = consistent ? `${consistent.username} (${consistent.country})` : '-';
    document.getElementById('summaryConsistentDays').textContent = consistent ? `${consistent.daysInTop20} days in Top 20` : '';
  }

  async function loadStats() {
    const mode = document.getElementById('dataMode').value;
    const country = document.getElementById('dataCountry').value;
    const date = document.getElementById('dataBaseDate').value;
    if (!date) return setDataStatus('Please choose a base date.', 'error');

    setDataStatus('Loading stats‚Ä¶', '');
    try {
      const qs = new URLSearchParams({ mode, country, date });
      const res = await fetch('/api-stats?' + qs.toString());
      const json = await res.json().catch(()=>({}));
      if (!res.ok || !json.ok) return setDataStatus(json.error || `Error ${res.status}`, 'error');

      statsCache = json;
      renderSummary(json);
      renderChart(json.chartSeries || []);
      renderTable(json.topPlayersOverall || []);
      setDataStatus(`Loaded ${json.mode} stats for ${json.fromDate} ‚Üí ${json.toDate}.`, 'ok');
    } catch (e) {
      setDataStatus('Network error loading stats.', 'error');
    }
  }
  document.getElementById('btnReloadStats')?.addEventListener('click', loadStats);

  document.getElementById('btnExportCsv')?.addEventListener('click', () => {
    if (!statsCache) return alert('No data yet. Click Refresh first.');
    const rows = statsCache.topPlayersOverall || [];
    const header = "rank,username,country,totalUsd,daysInTop20\n";
    const body = rows.map(r =>
      [r.rank, `"${String(r.username).replace(/"/g,'""')}"`, r.country, r.totalUsd, r.daysInTop20].join(',')
    ).join('\n');
    const blob = new Blob([header + body], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `turnover_stats_${statsCache.fromDate}_to_${statsCache.toDate}_${statsCache.country}_${statsCache.mode}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  });

  document.getElementById('btnExportPdf')?.addEventListener('click', () => {
    if (!statsCache) return alert('No data yet. Click Refresh first.');
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });

    doc.setFontSize(14);
    doc.text(`Turnover Analytics (USD)`, 40, 40);
    doc.setFontSize(10);
    doc.text(`${statsCache.fromDate} ‚Üí ${statsCache.toDate} | ${statsCache.country} | ${statsCache.mode}`, 40, 58);

    const tableRows = (statsCache.topPlayersOverall || []).slice(0, 30).map(r => [
      r.rank, r.username, r.country, `$${Number(r.totalUsd||0).toFixed(2)}`, r.daysInTop20
    ]);

    doc.autoTable({
      head: [[ "Rank", "Username", "Country", "Total USD", "Days in Top 20" ]],
      body: tableRows,
      startY: 80,
      styles: { fontSize: 9 }
    });

    doc.save(`turnover_stats_${statsCache.fromDate}_to_${statsCache.toDate}_${statsCache.country}_${statsCache.mode}.pdf`);
  });

  // ===== USER HISTORY =====
  async function loadUserHistory() {
    const username = (document.getElementById("uSearchName").value || "").trim();
    const country = document.getElementById("uSearchCountry").value || "";
    const tbody = document.getElementById("userTableBody");

    if (!username) return setAnyStatus("userStatus", "Please enter username.", "error");

    setAnyStatus("userStatus", "Loading‚Ä¶", "");
    tbody.innerHTML = "";

    try {
      const qs = new URLSearchParams({ username });
      if (country) qs.set("country", country);

      const res = await fetch("/api-user-history?" + qs.toString());
      const json = await res.json().catch(()=>({}));

      if (!res.ok || !json.ok) {
        setAnyStatus("userStatus", json.error || `Error ${res.status}`, "error");
        return;
      }

      const rows = json.rows || [];
      if (!rows.length) {
        setAnyStatus("userStatus", "No history found.", "ok");
        return;
      }

      rows.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.date || ""}</td>
          <td>${r.slot || ""}</td>
          <td>${r.country || ""}</td>
          <td>${Number(r.raw_turnover || 0).toFixed(2)}</td>
          <td><span class="badge bg-secondary">${r.batch_id || ""}</span></td>
          <td>${r.created_at || r.timestamp || ""}</td>
        `;
        tbody.appendChild(tr);
      });

      setAnyStatus("userStatus", `Loaded ${rows.length} rows.`, "ok");
    } catch (e) {
      setAnyStatus("userStatus", "Network error.", "error");
    }
  }

  // ===== UPLOAD HISTORY (VERIFY / REJECT) =====
  function statusBadge(status) {
    const s = String(status || "").toUpperCase();
    let cls = "badge-soft";
    if (s === "PENDING") cls += " badge-pending";
    else if (s === "APPROVED") cls += " badge-approved";
    else if (s === "REJECTED") cls += " badge-rejected";
    else if (s === "SUPERSEDED") cls += " badge-sup";
    return `<span class="${cls}">${s || "-"}</span>`;
  }

  async function loadUploadHistory() {
    const date = (document.getElementById("hDate").value || "").trim();
    const country = document.getElementById("hCountry").value || "";
    const tbody = document.getElementById("historyTableBody");

    setAnyStatus("historyStatus", "Loading‚Ä¶", "");
    tbody.innerHTML = "";

    try {
      const qs = new URLSearchParams();
      if (date) qs.set("date", date);
      if (country) qs.set("country", country);

      const res = await fetch("/api-upload-history?" + qs.toString());
      const json = await res.json().catch(()=>({}));

      if (!res.ok || !json.ok) {
        setAnyStatus("historyStatus", json.error || `Error ${res.status}`, "error");
        return;
      }

      const rows = json.rows || [];
      if (!rows.length) {
        setAnyStatus("historyStatus", "No upload history.", "ok");
        return;
      }

      rows.forEach(r => {
        const isPending = String(r.status || "").toUpperCase() === "PENDING";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.created_at || ""}</td>
          <td>${r.date || ""}</td>
          <td>${r.country || ""}</td>
          <td>${r.slot || ""}</td>
          <td>${statusBadge(r.status)}</td>
          <td>${r.rows_count ?? ""}</td>
          <td>${Number(r.total_local || 0).toFixed(2)}</td>
          <td>${Number(r.total_usd || 0).toFixed(2)}</td>
          <td>${r.uploader || ""}</td>
          <td>${r.verified_by || ""}</td>
          <td><code>${r.batch_id || ""}</code></td>
          <td>
            <button class="btn btn-outline-secondary btn-sm me-1" onclick="openBatchDetails('${r.batch_id}')">
              View
            </button>
            <button class="btn btn-success btn-sm me-1" onclick="verifyBatch('${r.batch_id}')" ${isPending ? "" : "disabled"}>
              ‚úÖ Verify
            </button>
            <button class="btn btn-danger btn-sm" onclick="openReject('${r.batch_id}')" ${isPending ? "" : "disabled"}>
              ‚ùå Reject
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      setAnyStatus("historyStatus", `Loaded ${rows.length} batches.`, "ok");
    } catch (e) {
      setAnyStatus("historyStatus", "Network error.", "error");
    }
  }

  // ===== ROLLBACK =====
  async function doRollback() {
    const date = (document.getElementById("rbDate").value || "").trim();
    const country = document.getElementById("rbCountry").value || "";
    const slotKey = (document.getElementById("rbSlot").value || "").trim();
    const batch_id = (document.getElementById("rbBatch").value || "").trim();
    const key = (document.getElementById("rbKey").value || "").trim();

    if (!date || !country || !slotKey || !batch_id || !key) {
      return setAnyStatus("rbStatus", "Missing fields.", "error");
    }

    setAnyStatus("rbStatus", "Rolling back‚Ä¶", "");
    try {
      const res = await fetch("/api-rollback", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ date, country, slotKey, batch_id, key })
      });
      const json = await res.json().catch(()=>({}));

      if (!res.ok || !json.ok) {
        setAnyStatus("rbStatus", json.error || `Error ${res.status}`, "error");
        return;
      }

      setAnyStatus("rbStatus", "Rollback success ‚úÖ", "ok");
      await loadGlobalLeaderboard();
      await loadStats();
      await loadUploadHistory();
    } catch (e) {
      setAnyStatus("rbStatus", "Network error.", "error");
    }
  }

  // ===== MODALS: Details + Reject =====
  let modalDetails = null;
  let modalReject = null;
  let rejectBatchId = null;

  function setModalStatus(id, msg, type) {
    setAnyStatus(id, msg, type);
  }

  async function openBatchDetails(batch_id) {
    setModalStatus("batchDetailsStatus", "Loading batch details‚Ä¶", "");
    document.getElementById("newBatchBox").innerHTML = "-";
    document.getElementById("currentBatchBox").innerHTML = "-";
    document.getElementById("tblNewRows").innerHTML = "";
    document.getElementById("tblCurrentRows").innerHTML = "";

    modalDetails.show();

    try {
      const res = await fetch("/api-batch-details?batch_id=" + encodeURIComponent(batch_id));
      const json = await res.json().catch(()=>({}));
      if (!res.ok || !json.ok) {
        setModalStatus("batchDetailsStatus", json.error || `Error ${res.status}`, "error");
        return;
      }

      const b = json.batch;
      const c = json.current;

      const boxHtml = (x) => {
        if (!x) return `<div class="text-muted">No approved batch yet.</div>`;
        return `
          <div class="text-small"><b>Date:</b> ${x.date} | <b>Country:</b> ${x.country} | <b>Slot:</b> ${x.slot}</div>
          <div class="text-small"><b>Status:</b> ${x.status || "-"}</div>
          <div class="text-small"><b>Batch:</b> <code>${x.batch_id}</code></div>
          <div class="text-small"><b>Rows:</b> ${x.rows_count}</div>
          <div class="text-small"><b>Total Local:</b> ${Number(x.total_local||0).toFixed(2)}</div>
          <div class="text-small"><b>Total USD:</b> ${Number(x.total_usd||0).toFixed(2)}</div>
          <div class="text-small"><b>Uploader:</b> ${x.uploader || "-"}</div>
          <hr class="my-2"/>
          <div class="text-small"><b>Verified By:</b> ${x.verified_by || "-"}</div>
          <div class="text-small"><b>Verified At:</b> ${x.verified_at || "-"}</div>
          ${x.reject_reason ? `<div class="text-small text-danger"><b>Reject Reason:</b> ${x.reject_reason}</div>` : ""}
        `;
      };

      document.getElementById("newBatchBox").innerHTML = boxHtml(b);
      document.getElementById("currentBatchBox").innerHTML = boxHtml(c);

      const renderRows = (tbodyId, rows) => {
        const tb = document.getElementById(tbodyId);
        tb.innerHTML = "";
        (rows || []).forEach((r, idx) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${idx+1}</td><td>${r.username}</td><td>${Number(r.raw_turnover||0).toFixed(2)}</td>`;
          tb.appendChild(tr);
        });
      };

      renderRows("tblNewRows", json.rows_new);
      renderRows("tblCurrentRows", json.rows_current);

      setModalStatus("batchDetailsStatus", "Loaded ‚úÖ (left = new upload, right = current published)", "ok");
    } catch (e) {
      setModalStatus("batchDetailsStatus", "Network error loading details.", "error");
    }
  }

  async function verifyBatch(batch_id) {
    if (!confirm("Verify & Publish this batch?")) return;

    try {
      const res = await fetch("/api-verify-batch", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ batch_id })
      });
      const json = await res.json().catch(()=>({}));
      if (!res.ok || !json.ok) return alert(json.error || `Verify failed (${res.status})`);

      alert("Verified & Published ‚úÖ (Telegram sent)");
      await loadUploadHistory();
      await loadGlobalLeaderboard();
      await loadStats();
    } catch (e) {
      alert("Network error verifying.");
    }
  }

  function openReject(batch_id) {
    rejectBatchId = batch_id;
    document.getElementById("rejectBatchId").textContent = batch_id;
    document.getElementById("rejectReason").value = "";
    setModalStatus("rejectStatus", "", "");
    modalReject.show();
  }

  async function submitReject() {
    const reason = (document.getElementById("rejectReason").value || "").trim();
    if (!rejectBatchId) return;
    if (!reason) return setModalStatus("rejectStatus", "Reason is required.", "error");

    setModalStatus("rejectStatus", "Rejecting‚Ä¶", "");

    try {
      const res = await fetch("/api-reject-batch", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ batch_id: rejectBatchId, reason })
      });
      const json = await res.json().catch(()=>({}));
      if (!res.ok || !json.ok) {
        setModalStatus("rejectStatus", json.error || `Reject failed (${res.status})`, "error");
        return;
      }

      setModalStatus("rejectStatus", "Rejected ‚úÖ (Telegram sent)", "ok");
      setTimeout(() => modalReject.hide(), 650);
      await loadUploadHistory();
    } catch (e) {
      setModalStatus("rejectStatus", "Network error rejecting.", "error");
    }
  }

  // ===== FAKE CRUD (same as your original) =====
  let fakeEditingId = null;

  function setFakeStatus(msg, type) {
    setAnyStatus("fakeStatus", msg, type);
  }

  async function loadFakeList() {
    const date = document.getElementById("fakeDate")?.value;
    if (!date) return setFakeStatus("Choose a date.", "error");

    setFakeStatus("Loading‚Ä¶", "");
    const tbody = document.querySelector("#tblFake tbody");
    if (tbody) tbody.innerHTML = "";

    try {
      const res = await fetch("/api-fake-list?date=" + encodeURIComponent(date));
      const json = await res.json().catch(()=>({}));
      if (!res.ok || !json.ok) return setFakeStatus(json.error || `Error ${res.status}`, "error");

      const rows = json.rows || [];
      if (!rows.length) {
        setFakeStatus("No fake users for this date yet.", "ok");
        return;
      }

      rows.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>
            <input type="checkbox" ${Number(r.is_active) ? "checked" : ""} data-id="${r.id}" class="fakeActiveToggle">
          </td>
          <td>${r.username || ""}</td>
          <td>${r.country || "ALL"}</td>
          <td>${Number(r.boost_pct || 0).toFixed(2)}</td>
          <td>${r.note || ""}</td>
          <td class="text-small">${r.created_at || ""}</td>
          <td>
            <button class="btn btn-outline-primary btn-sm me-1 fakeEditBtn" data-id="${r.id}">Edit</button>
            <button class="btn btn-outline-danger btn-sm fakeDelBtn" data-id="${r.id}">Delete</button>
          </td>
        `;
        tr.dataset.row = JSON.stringify(r);
        tbody.appendChild(tr);
      });

      setFakeStatus(`Loaded ${rows.length} fake rows.`, "ok");

      document.querySelectorAll(".fakeEditBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          const tr = btn.closest("tr");
          const r = JSON.parse(tr.dataset.row || "{}");
          fakeEditingId = r.id;

          document.getElementById("fakeCountry").value = r.country || "ALL";
          document.getElementById("fakeUsername").value = r.username || "";
          document.getElementById("fakeBoost").value = r.boost_pct || "";
          document.getElementById("fakeNote").value = r.note || "";

          setFakeStatus(`Editing ID ${r.id}`, "ok");
        });
      });

      document.querySelectorAll(".fakeDelBtn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = Number(btn.dataset.id);
          if (!confirm("Delete this fake user?")) return;

          setFakeStatus("Deleting‚Ä¶", "");
          const res = await fetch("/api-fake-delete", {
            method: "POST",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify({ id })
          });
          const json = await res.json().catch(()=>({}));
          if (!res.ok || !json.ok) return setFakeStatus(json.error || `Error ${res.status}`, "error");

          setFakeStatus("Deleted ‚úÖ", "ok");
          await loadFakeList();
        });
      });

      document.querySelectorAll(".fakeActiveToggle").forEach(cb => {
        cb.addEventListener("change", async () => {
          const id = Number(cb.dataset.id);
          const tr = cb.closest("tr");
          const r = JSON.parse(tr.dataset.row || "{}");
          const is_active = cb.checked ? 1 : 0;

          const payload = {
            id,
            date: r.date,
            country: r.country || "ALL",
            username: r.username,
            boost_pct: r.boost_pct,
            is_active,
            note: r.note || ""
          };

          const res = await fetch("/api-fake-upsert", {
            method: "POST",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify(payload)
          });
          const json = await res.json().catch(()=>({}));
          if (!res.ok || !json.ok) {
            setFakeStatus(json.error || `Error ${res.status}`, "error");
            cb.checked = !cb.checked;
            return;
          }
          setFakeStatus("Updated ‚úÖ", "ok");
          await loadFakeList();
        });
      });

    } catch (e) {
      setFakeStatus("Network error.", "error");
    }
  }

  async function saveFakeRow() {
    const date = document.getElementById("fakeDate").value;
    const country = document.getElementById("fakeCountry").value;
    const username = (document.getElementById("fakeUsername").value || "").trim();
    const boost_pct = Number(document.getElementById("fakeBoost").value);
    const note = (document.getElementById("fakeNote").value || "").trim();

    if (!date) return setFakeStatus("Choose a date.", "error");
    if (!username) return setFakeStatus("Username required.", "error");
    if (!Number.isFinite(boost_pct) || boost_pct <= 0) return setFakeStatus("Boost% must be > 0.", "error");

    setFakeStatus("Saving‚Ä¶", "");

    const payload = {
      id: fakeEditingId,
      date,
      country,
      username,
      boost_pct,
      is_active: 1,
      note
    };

    try {
      const res = await fetch("/api-fake-upsert", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const json = await res.json().catch(()=>({}));
      if (!res.ok || !json.ok) return setFakeStatus(json.error || `Error ${res.status}`, "error");

      fakeEditingId = null;
      document.getElementById("fakeUsername").value = "";
      document.getElementById("fakeBoost").value = "";
      document.getElementById("fakeNote").value = "";
      document.getElementById("fakeCountry").value = "ALL";

      setFakeStatus("Saved ‚úÖ", "ok");
      await loadFakeList();
    } catch (e) {
      setFakeStatus("Network error.", "error");
    }
  }

  // ------- Default dates = Mexico time UTC-6 -------
  function todayMexicoISO() {
    const nowUtcMs = Date.now();
    const offsetMs = -6 * 60 * 60 * 1000;
    const mexNow = new Date(nowUtcMs + offsetMs);
    const y = mexNow.getFullYear();
    const m = String(mexNow.getMonth() + 1).padStart(2, "0");
    const d = String(mexNow.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }

  document.addEventListener("DOMContentLoaded", async () => {
    modalDetails = new bootstrap.Modal(document.getElementById("batchDetailsModal"));
    modalReject = new bootstrap.Modal(document.getElementById("rejectModal"));

    document.getElementById("btnUserSearch")?.addEventListener("click", loadUserHistory);
    document.getElementById("btnHistoryLoad")?.addEventListener("click", loadUploadHistory);
    document.getElementById("btnRollback")?.addEventListener("click", doRollback);

    document.getElementById("btnFakeSave")?.addEventListener("click", saveFakeRow);
    document.getElementById("fakeDate")?.addEventListener("change", loadFakeList);
    document.getElementById("fakeCountry")?.addEventListener("change", loadFakeList);

    document.getElementById('globalSearchBtn')?.addEventListener('click', loadGlobalLeaderboard);

    showTab('global');
    const today = todayMexicoISO();

    document.getElementById('globalDate').value = today;
    document.getElementById('brDate').value = today;
    document.getElementById('mxDate').value = today;
    document.getElementById('dataBaseDate').value = today;

    const fd = document.getElementById('fakeDate');
    if (fd) fd.value = today;

    const rbDate = document.getElementById('rbDate');
    const hDate = document.getElementById('hDate');
    if (rbDate) rbDate.value = today;
    if (hDate) hDate.value = today;

    refreshAutoSlotUI();
    setInterval(refreshAutoSlotUI, 30 * 1000);

    await loadGlobalLeaderboard();
    await loadUploadHistory();
  });
</script>

</body>
</html>
