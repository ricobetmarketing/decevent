<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Turnover Backend – Brazil & Mexico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
    }
    .page {
      max-width: 960px;
      margin: 0 auto;
    }
    h1 {
      font-size: 22px;
      margin: 4px 0 12px;
    }
    .sub {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 16px;
    }
    .tabs {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid #4b5563;
      padding: 3px;
      margin-bottom: 16px;
      background: #020617;
    }
    .tab {
      border-radius: 999px;
      padding: 6px 16px;
      font-size: 13px;
      cursor: pointer;
      border: none;
      background: transparent;
      color: #9ca3af;
    }
    .tab.active {
      background: linear-gradient(135deg, #22c55e, #4ade80);
      color: #022c22;
      font-weight: 600;
    }
    .card {
      border-radius: 18px;
      border: 1px solid #374151;
      background: #020617;
      box-shadow: 0 10px 28px rgba(0, 0, 0, 0.9);
      padding: 16px;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 10px;
    }
    label {
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    input[type="date"],
    select {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      min-width: 160px;
    }
    textarea {
      width: 100%;
      min-height: 260px;
      border-radius: 10px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco,
        Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      padding: 8px;
      resize: vertical;
    }
    .hint {
      font-size: 12px;
      color: #9ca3af;
      margin: 4px 0 8px;
    }
    .btn-row {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    button.save-btn {
      border-radius: 999px;
      border: none;
      padding: 8px 18px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #22c55e, #4ade80);
      color: #022c22;
      box-shadow: 0 10px 20px rgba(34, 197, 94, 0.8);
    }
    button.preview-btn {
      border-radius: 999px;
      border: 1px solid #4b5563;
      padding: 8px 16px;
      font-size: 13px;
      cursor: pointer;
      background: #020617;
      color: #e5e7eb;
    }
    .status {
      font-size: 13px;
      color: #e5e7eb;
    }
    .status.error {
      color: #fecaca;
    }
    .status.ok {
      color: #bbf7d0;
    }
    .small {
      font-size: 11px;
      color: #9ca3af;
    }
    @media (max-width: 600px) {
      .card { padding: 12px; }
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>Turnover Backend – Daily Leaderboard</h1>
    <p class="sub">
      Paste <strong>Username, Turnover</strong> for each 2-hour cumulative update
      (00:00–02:00, 00:00–04:00, 00:00–06:00... Mexico time).<br />
      For Brazil you can optionally add a 3rd column
      <strong>00:00–03:00 (Brazil local)</strong> and it will be auto-subtracted.
    </p>

    <div class="tabs">
      <button class="tab active" data-country="BR">Brazil</button>
      <button class="tab" data-country="MX">Mexico</button>
    </div>

    <div class="card">
      <div class="row">
        <label>
          Leaderboard Date (Mexico day)
          <input type="date" id="lbDate" />
        </label>

        <label>
          Time Slot (cumulative from 00:00 Mexico)
          <select id="slotSelect">
            <option value="00-02">00:00 – 02:00</option>
            <option value="00-04">00:00 – 04:00</option>
            <option value="00-06">00:00 – 06:00</option>
            <option value="00-08">00:00 – 08:00</option>
            <option value="00-10">00:00 – 10:00</option>
            <option value="00-12">00:00 – 12:00</option>
            <option value="00-14">00:00 – 14:00</option>
            <option value="00-16">00:00 – 16:00</option>
            <option value="00-18">00:00 – 18:00</option>
            <option value="00-20">00:00 – 20:00</option>
            <option value="00-22">00:00 – 22:00</option>
            <option value="00-24">00:00 – 24:00</option>
          </select>
        </label>
      </div>

      <p class="hint">
        Format per line:<br />
        <code>username,turnover</code> or<br />
        <code>username,turnover,turnover_00_03</code> (Brazil).<br />
        Examples:<br />
        <code>fabiano199,2500.50</code><br />
        <code>fabiano199,2500.50,200.00</code>
      </p>

      <textarea
        id="rawInput"
        placeholder="username,turnover&#10;fabiano199,2500.50&#10;user2,100"
      ></textarea>

      <div class="btn-row">
        <button class="save-btn" id="saveBtn">Save Records</button>
        <button class="preview-btn" id="previewBtn" type="button">
          Preview parsed rows
        </button>
        <span id="status" class="status small"></span>
      </div>

      <p class="small" style="margin-top:10px;">
        • Backend keeps full history per date / country / slot.<br />
        • The leaderboard always uses the <strong>latest cumulative slot</strong> per player.<br />
        • Brazil's 00:00–03:00 turnover (if provided) is auto-subtracted before converting to USD.
      </p>
    </div>
  </div>

  <script>
    const tabs = document.querySelectorAll(".tab");
    const lbDate = document.getElementById("lbDate");
    const slotSelect = document.getElementById("slotSelect");
    const rawInput = document.getElementById("rawInput");
    const saveBtn = document.getElementById("saveBtn");
    const previewBtn = document.getElementById("previewBtn");
    const statusEl = document.getElementById("status");

    let currentCountry = "BR";

    // Default to today
    lbDate.value = new Date().toISOString().slice(0, 10);

    tabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        tabs.forEach((t) => t.classList.remove("active"));
        tab.classList.add("active");
        currentCountry = tab.getAttribute("data-country") || "BR";
      });
    });

    function parseLines(text) {
      const lines = text.split(/\r?\n/).map((l) => l.trim()).filter(Boolean);
      const records = [];
      for (const line of lines) {
        const parts = line.split(",").map((s) => (s || "").trim());
        if (parts.length < 2) continue;
        const username = parts[0];
        const turnover = Number(parts[1] || 0);
        const earlyAdjust = parts.length >= 3 ? Number(parts[2] || 0) : 0;
        if (!username) continue;
        records.push({ username, turnover, earlyAdjust });
      }
      return records;
    }

    previewBtn.addEventListener("click", () => {
      const txt = rawInput.value;
      if (!txt.trim()) {
        statusEl.textContent = "Nothing to preview.";
        statusEl.className = "status small";
        return;
      }
      const records = parseLines(txt);
      statusEl.textContent =
        `Preview: ${records.length} rows parsed. ` +
        (records[0] ? `First: ${JSON.stringify(records[0])}` : "");
      statusEl.className = "status small";
    });

    saveBtn.addEventListener("click", () => {
      const date = lbDate.value;
      const slot = slotSelect.value;
      const txt = rawInput.value;

      if (!date) {
        statusEl.textContent = "Please select a date.";
        statusEl.className = "status error";
        return;
      }
      if (!txt.trim()) {
        statusEl.textContent = "Please paste some data.";
        statusEl.className = "status error";
        return;
      }

      const records = parseLines(txt);
      if (!records.length) {
        statusEl.textContent = "No valid rows found in input.";
        statusEl.className = "status error";
        return;
      }

      const payload = {
        date,
        country: currentCountry,
        slot,
        records
      };

      statusEl.textContent = "Saving...";
      statusEl.className = "status small";

      fetch("/admin/leaderboard", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.error) {
            statusEl.textContent = "Error: " + data.error;
            statusEl.className = "status error";
          } else {
            statusEl.textContent =
              `Saved ${records.length} rows for ${data.date} ` +
              `[${data.country}] slot ${data.slot}. ` +
              `Players in daily board: ${data.totalPlayers}.`;
            statusEl.className = "status ok";
          }
        })
        .catch((err) => {
          console.error(err);
          statusEl.textContent = "Network error.";
          statusEl.className = "status error";
        });
    });
  </script>
</body>
</html>
