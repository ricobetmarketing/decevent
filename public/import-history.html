<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Import History (Google Sheet → D1)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f8f9fa; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .small { font-size: 12px; }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h1 class="h4 mb-0">History Import</h1>
      <a class="btn btn-outline-secondary btn-sm" href="/admin-turnover.html">Back to Admin</a>
    </div>

    <div class="alert alert-info small">
      This importer reads your Google Sheet CSV (Date, Username, Turnover_USD) and sends it into
      <span class="mono">/api-admin-save</span> by grouping rows per date.
      <br>
      Conversion used:
      <b>BR:</b> USD×5 → BRL, <b>MX:</b> USD×18 → MXN.
    </div>

    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">CSV File</label>
            <input id="file" type="file" class="form-control" accept=".csv">
            <div class="text-muted small mt-1">
              Expected headers (case-insensitive): <span class="mono">Date, Username, Turnover_USD</span>
              (extra columns ok).
            </div>
          </div>

          <div class="col-md-3">
            <label class="form-label">Country</label>
            <select id="country" class="form-select">
              <option value="BR">BR (USD×5 → BRL)</option>
              <option value="MX">MX (USD×18 → MXN)</option>
            </select>
          </div>

          <div class="col-md-3">
            <label class="form-label">Slot Key</label>
            <input id="slotKey" class="form-control" value="00_24" />
            <div class="text-muted small mt-1">Use <span class="mono">00_24</span> for “end-of-day”.</div>
          </div>

          <div class="col-12">
            <button id="btnPreview" class="btn btn-secondary me-2">Preview</button>
            <button id="btnImport" class="btn btn-primary" disabled>Import to D1</button>
            <span id="status" class="ms-3 small text-muted"></span>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="mb-2">Preview</h6>
        <div class="small text-muted mb-2">Shows first 20 parsed rows + how many dates will be imported.</div>
        <pre id="preview" class="mono small mb-0" style="white-space:pre-wrap"></pre>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  function parseCSV(text) {
    // Simple CSV parser (handles commas + quotes).
    const lines = text.split(/\r?\n/).filter(l => l.trim().length);
    if (!lines.length) return { rows: [], error: "Empty CSV" };

    const parseLine = (line) => {
      const out = [];
      let cur = "", inQ = false;
      for (let i=0;i<line.length;i++){
        const c = line[i];
        if (c === '"' ) {
          if (inQ && line[i+1] === '"') { cur += '"'; i++; }
          else inQ = !inQ;
        } else if (c === ',' && !inQ) {
          out.push(cur); cur = "";
        } else cur += c;
      }
      out.push(cur);
      return out.map(s => s.trim());
    };

    const header = parseLine(lines[0]).map(h => h.trim().toLowerCase());
    const idxDate = header.indexOf("date");
    const idxUser = header.indexOf("username");
    let idxUsd = header.indexOf("turnover_usd");
    if (idxUsd === -1) idxUsd = header.indexOf("turnoverusd");

    if (idxDate === -1 || idxUser === -1 || idxUsd === -1) {
      return { rows: [], error: "Missing required headers: Date, Username, Turnover_USD" };
    }

    const rows = [];
    for (let i=1;i<lines.length;i++){
      const cols = parseLine(lines[i]);
      const date = (cols[idxDate] || "").trim();
      const username = (cols[idxUser] || "").trim();
      const usdRaw = (cols[idxUsd] || "").trim().replace(/,/g, "");
      const usd = Number(usdRaw);

      if (!date || !username) continue;
      if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) continue;
      if (!Number.isFinite(usd)) continue;

      rows.push({ date, username, usd });
    }
    return { rows, error: null };
  }

  function groupByDate(rows) {
    const m = new Map();
    for (const r of rows) {
      if (!m.has(r.date)) m.set(r.date, []);
      m.get(r.date).push(r);
    }
    // sort dates asc
    return Array.from(m.entries()).sort((a,b) => a[0].localeCompare(b[0]));
  }

  function usdToLocal(country, usd) {
    if (country === "BR") return usd * 5;
    if (country === "MX") return usd * 18;
    return usd;
  }

  let parsedRows = [];
  let grouped = [];

  $("btnPreview").addEventListener("click", async () => {
    const f = $("file").files?.[0];
    if (!f) { $("status").textContent = "Please choose a CSV file."; return; }

    $("status").textContent = "Reading file…";
    const text = await f.text();

    const res = parseCSV(text);
    if (res.error) {
      $("preview").textContent = res.error;
      $("status").textContent = "Preview failed.";
      $("btnImport").disabled = true;
      return;
    }

    parsedRows = res.rows;
    grouped = groupByDate(parsedRows);

    const country = $("country").value;
    const slotKey = ($("slotKey").value || "00_24").trim();

    const sample = parsedRows.slice(0, 20).map(r => {
      const local = usdToLocal(country, r.usd);
      return `${r.date}  ${r.username}  USD=${r.usd.toFixed(2)}  local=${local.toFixed(2)}  slot=${slotKey}`;
    }).join("\n");

    $("preview").textContent =
      `Parsed rows: ${parsedRows.length}\n` +
      `Unique dates: ${grouped.length}\n\n` +
      `First rows:\n${sample}`;

    $("status").textContent = `Ready. ${grouped.length} dates will be imported.`;
    $("btnImport").disabled = grouped.length === 0;
  });

  $("btnImport").addEventListener("click", async () => {
    const country = $("country").value;
    const slotKey = ($("slotKey").value || "00_24").trim();

    if (!grouped.length) return;

    $("btnImport").disabled = true;
    $("status").textContent = "Import running…";

    let okDates = 0;
    let failDates = 0;

    for (let i=0;i<grouped.length;i++){
      const [date, rows] = grouped[i];

      // build rows for api-admin-save (local currency!)
      const payloadRows = rows.map(r => ({
        username: r.username,
        turnover: usdToLocal(country, r.usd)
      }));

      $("status").textContent = `Importing ${i+1}/${grouped.length} — ${date} (${payloadRows.length} rows)…`;

      try {
        const res = await fetch("/api-admin-save", {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ country, date, slotKey, rows: payloadRows })
        });
        const json = await res.json().catch(()=>({}));

        if (!res.ok || !json.ok) {
          failDates++;
          console.error("Import failed for date", date, json);
        } else {
          okDates++;
        }
      } catch (e) {
        failDates++;
        console.error("Network error", e);
      }

      // small delay to avoid rate-limits
      await new Promise(r => setTimeout(r, 250));
    }

    $("status").textContent = `Done ✅  Success: ${okDates} dates | Failed: ${failDates} dates`;
    $("btnImport").disabled = false;
  });
</script>
</body>
</html>
