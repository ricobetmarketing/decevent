<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Import History (USD)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f8f9fa; }
    .card { box-shadow:0 6px 20px rgba(0,0,0,.08); border:0; }
    textarea { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 13px; }
    .hint { font-size: 12px; color:#6b7280; }
  </style>
</head>
<body class="p-3 p-md-4">

  <div class="container" style="max-width: 980px;">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h1 class="h4 mb-0">Import Historical Data (USD)</h1>
<a class="btn btn-outline-secondary btn-sm" href="/admin-turnover.html">← Back to Admin</a>

    </div>

    <div class="card mb-3">
      <div class="card-body">
        <div class="alert alert-warning mb-3">
          This importer is for <b>historical daily totals in USD</b> from your old Google Sheet.<br/>
          It will be saved into <code>raw_turnover</code> with <code>slot_key = IMPORT_USD</code>.
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Import Key</label>
            <input id="importKey" class="form-control" placeholder="(the IMPORT_KEY secret value)" />
            <div class="hint mt-1">This is required to prevent public access (403 if wrong).</div>
          </div>

          <div class="col-md-6 d-flex align-items-end">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="overwrite" />
              <label class="form-check-label" for="overwrite">
                Overwrite existing IMPORT_USD rows (same date + country)
              </label>
              <div class="hint">Safe: only deletes <code>slot_key=IMPORT_USD</code>, never touches live slots.</div>
            </div>
          </div>

          <div class="col-12">
            <label class="form-label">Paste CSV or Upload File</label>
            <input type="file" class="form-control mb-2" id="csvFile" accept=".csv" />
            <textarea id="csvText" class="form-control" rows="12" placeholder="date,username,turnover_usd,country&#10;2025-12-09,adriantkk,228.82,BR"></textarea>
            <div class="hint mt-2">
              Required columns: <code>date</code>, <code>username</code>, <code>turnover_usd</code>, <code>country</code> (BR/MX)
            </div>
          </div>

          <div class="col-12 d-flex gap-2">
            <button id="btnImport" class="btn btn-primary">Import Now</button>
            <button id="btnExample" class="btn btn-outline-secondary">Fill Example</button>
          </div>

          <div class="col-12">
            <div id="status" class="mt-2"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  $("csvFile").addEventListener("change", () => {
    const f = $("csvFile").files && $("csvFile").files[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = (e) => { $("csvText").value = e.target.result || ""; };
    reader.readAsText(f);
  });

  $("btnExample").addEventListener("click", () => {
    $("csvText").value =
`date,username,turnover_usd,country
2025-12-09,adriantkk,228.82,BR
2025-12-09,oakleyisla,2267.54,BR
2025-12-09,ramont,621.33,BR
2025-12-09,mxplayer01,150.10,MX`;
  });

  function setStatus(html, type) {
    const el = $("status");
    el.className = "";
    if (type === "ok") el.classList.add("alert","alert-success");
    else if (type === "error") el.classList.add("alert","alert-danger");
    else el.classList.add("alert","alert-secondary");
    el.innerHTML = html;
  }

  $("btnImport").addEventListener("click", async () => {
    const key = $("importKey").value.trim();
    const csv = $("csvText").value;
    const overwrite = $("overwrite").checked;

    if (!key) return setStatus("Missing Import Key.", "error");
    if (!csv.trim()) return setStatus("CSV is empty.", "error");

    setStatus("Importing…", "");

    try {
      const res = await fetch("/api-import-history", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-import-key": key
        },
        body: JSON.stringify({ csv, overwrite })
      });

      const json = await res.json().catch(() => ({}));
      if (!res.ok || !json.ok) {
        return setStatus(`Failed: ${json.error || ("HTTP " + res.status)}`, "error");
      }

      setStatus(`✅ Imported <b>${json.inserted}</b> rows into <code>raw_turnover</code> (slot_key=<code>${json.slot_key}</code>).`, "ok");
    } catch (e) {
      setStatus("Network error while importing.", "error");
    }
  });
</script>
</body>
</html>
